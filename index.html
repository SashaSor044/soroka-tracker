<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú—ñ–π –ü–∞–ª–∏–≤–Ω–∏–π –¢—Ä–µ–∫–µ—Ä</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Light green background */
        }
        .gradient-button {
            background-image: linear-gradient(to right, #34d399, #10b981); /* Green gradient */
            transition: all 0.3s ease;
        }
        .gradient-button:hover {
            background-image: linear-gradient(to right, #10b981, #059669); /* Darker green gradient on hover */
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4);
        }
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all duration-200;
        }
        .card {
            @apply bg-white p-6 rounded-xl shadow-lg border border-emerald-100;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #10B981;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen items-center justify-center p-4 sm:p-6 lg:p-8">

    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="flex flex-col items-center justify-center text-center p-8 bg-white rounded-2xl shadow-xl border border-emerald-200 max-w-md w-full">
        <h1 class="text-4xl font-bold text-emerald-800 mb-4">–ó–æ—Ä—è–Ω–æ, –≤—ñ—Ç–∞—î–º–æ! üëã</h1>
        <p class="text-lg text-gray-600 mb-8">–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –¥–æ –≤–∞—à–æ–≥–æ –ü–∞–ª–∏–≤–Ω–æ–≥–æ –¢—Ä–µ–∫–µ—Ä–∞.</p>
        <button id="continueBtn" class="gradient-button py-3 px-8 text-white font-bold text-lg rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-emerald-300">
            –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏
        </button>
    </div>

    <!-- Main App Content (Initially Hidden) -->
    <div id="mainApp" class="max-w-3xl w-full bg-white rounded-2xl shadow-xl p-6 sm:p-8 lg:p-10 mb-8 border border-emerald-200 hidden">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-emerald-800 mb-6">
            <span class="block text-emerald-600">‚õΩ –ú—ñ–π –ü–∞–ª–∏–≤–Ω–∏–π –¢—Ä–µ–∫–µ—Ä</span>
        </h1>
        <p class="text-center text-gray-600 mb-8 text-lg">
            –í—ñ–¥—Å—Ç–µ–∂—É–π—Ç–µ –∑–∞–ø—Ä–∞–≤–∫–∏ —Ç–∞ –æ—Ü—ñ–Ω—é–π—Ç–µ –∑–∞–ª–∏—à–æ–∫ –ø–∞–ª–∏–≤–∞.
            <span class="block text-sm text-gray-500 mt-2">–í–∞—à —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: <span id="userIdDisplay" class="font-mono text-xs bg-gray-100 p-1 rounded">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span></span>
        </p>

        <!-- Section for Adding New Fuel Log -->
        <div class="card mb-8">
            <h2 class="text-xl font-semibold text-emerald-700 mb-4">–î–æ–¥–∞—Ç–∏ –ó–∞–ø–∏—Å –ø—Ä–æ –ó–∞–ø—Ä–∞–≤–∫—É</h2>
            <div class="mb-4">
                <label for="odometerRefuel" class="block text-gray-700 text-sm font-medium mb-2">–ü–æ–∫–∞–∑–Ω–∏–∫ –æ–¥–æ–º–µ—Ç—Ä–∞ –ø—Ä–∏ –∑–∞–ø—Ä–∞–≤—Ü—ñ (–∫–º)</label>
                <input type="number" id="odometerRefuel" class="input-field" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, 123456">
            </div>
            <div class="mb-4">
                <label for="fuelAdded" class="block text-gray-700 text-sm font-medium mb-2">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥–æ–¥–∞–Ω–æ–≥–æ –ø–∞–ª–∏–≤–∞ (–ª—ñ—Ç—Ä—ñ–≤)</label>
                <input type="number" id="fuelAdded" class="input-field" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, 30">
            </div>
            <button id="addFuelLogBtn" class="gradient-button w-full py-3 px-4 text-white font-bold rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-emerald-300 flex items-center justify-center">
                <span id="addFuelLogBtnText">–î–æ–¥–∞—Ç–∏ –ó–∞–ø–∏—Å</span>
                <div id="addFuelLogSpinner" class="loading-spinner ml-2 hidden"></div>
            </button>
            <p id="addLogMessage" class="text-sm mt-2 text-center"></p>
        </div>

        <!-- Section for Estimating Current Fuel -->
        <div class="card mb-8">
            <h2 class="text-xl font-semibold text-emerald-700 mb-4">–û—Ü—ñ–Ω–∏—Ç–∏ –ü–æ—Ç–æ—á–Ω–∏–π –ó–∞–ª–∏—à–æ–∫ –ü–∞–ª–∏–≤–∞</h2>
            <div class="mb-4">
                <label for="currentOdometerEstimate" class="block text-gray-700 text-sm font-medium mb-2">–ü–æ—Ç–æ—á–Ω–∏–π –ø–æ–∫–∞–∑–Ω–∏–∫ –æ–¥–æ–º–µ—Ç—Ä–∞ (–∫–º)</label>
                <input type="number" id="currentOdometerEstimate" class="input-field" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, 123500">
            </div>
            <button id="estimateFuelBtn" class="gradient-button w-full py-3 px-4 text-white font-bold rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-emerald-300 flex items-center justify-center">
                <span id="estimateFuelBtnText">–û—Ü—ñ–Ω–∏—Ç–∏</span>
                <div id="estimateFuelSpinner" class="loading-spinner ml-2 hidden"></div>
            </button>
            <p id="estimateMessage" class="text-sm mt-2 text-center"></p>

            <div id="estimateResults" class="mt-6 p-4 bg-emerald-50 rounded-lg border border-emerald-100 hidden">
                <h3 class="text-lg font-semibold text-emerald-700 mb-2">–í–∞—à–∞ –û—Ü—ñ–Ω–∫–∞:</h3>
                <p class="text-xl font-bold text-emerald-600">–ó–∞–ª–∏—à–æ–∫ –ø–∞–ª–∏–≤–∞: <span id="fuelRemaining">0</span> –ª</p>
                <p class="text-xl font-bold text-emerald-600">–ó–∞–ª–∏—à–∏–ª–æ—Å—å –ø—Ä–æ—ó—Ö–∞—Ç–∏: <span id="distanceRemaining">0</span> –∫–º</p>
                <p class="text-sm text-gray-500 mt-2">
                    <span class="font-semibold">–ü—Ä–∏–º—ñ—Ç–∫–∞:</span> –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π –∑–∞–ø—Ä–∞–≤—Ü—ñ —Ç–∞ —Ñ—ñ–∫—Å–æ–≤–∞–Ω—ñ–π –≤–∏—Ç—Ä–∞—Ç—ñ 8–ª/100–∫–º.
                </p>
            </div>
        </div>

        <!-- Section for Fuel Log History -->
        <div class="card">
            <h2 class="text-xl font-semibold text-emerald-700 mb-4">–Ü—Å—Ç–æ—Ä—ñ—è –ó–∞–ø—Ä–∞–≤–æ–∫</h2>
            <div id="fuelLogsList" class="space-y-3">
                <p id="noLogsMessage" class="text-gray-500 text-center">–ó–∞–ø–∏—Å—ñ–≤ –ø—Ä–æ –∑–∞–ø—Ä–∞–≤–∫–∏ –ø–æ–∫–∏ –Ω–µ–º–∞—î.</p>
                <!-- Fuel logs will be inserted here -->
            </div>
            <div id="logsLoadingSpinner" class="flex justify-center items-center mt-4 hidden">
                <div class="loading-spinner"></div>
                <span class="ml-2 text-gray-600">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–ø–∏—Å—ñ–≤...</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous until authenticated

        // DOM Elements
        const welcomeScreen = document.getElementById('welcomeScreen');
        const mainApp = document.getElementById('mainApp');
        const continueBtn = document.getElementById('continueBtn');

        const odometerRefuelInput = document.getElementById('odometerRefuel');
        const fuelAddedInput = document.getElementById('fuelAdded');
        const addFuelLogBtn = document.getElementById('addFuelLogBtn');
        const addFuelLogBtnText = document.getElementById('addFuelLogBtnText');
        const addFuelLogSpinner = document.getElementById('addFuelLogSpinner');
        const addLogMessage = document.getElementById('addLogMessage');

        const currentOdometerEstimateInput = document.getElementById('currentOdometerEstimate');
        const estimateFuelBtn = document.getElementById('estimateFuelBtn');
        const estimateFuelBtnText = document.getElementById('estimateFuelBtnText');
        const estimateFuelSpinner = document.getElementById('estimateFuelSpinner');
        const estimateMessage = document.getElementById('estimateMessage');
        const estimateResultsDiv = document.getElementById('estimateResults');
        const fuelRemainingSpan = document.getElementById('fuelRemaining');
        const distanceRemainingSpan = document.getElementById('distanceRemaining');

        const fuelLogsList = document.getElementById('fuelLogsList');
        const noLogsMessage = document.getElementById('noLogsMessage');
        const logsLoadingSpinner = document.getElementById('logsLoadingSpinner');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // Fixed fuel consumption rate
        const FUEL_CONSUMPTION_RATE_L_PER_100KM = 8; // liters per 100 km

        // Global variable to store the last fuel log for estimation
        let lastFuelLog = null;

        // Initialize Firebase and authenticate
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Set userId after authentication
                auth.onAuthStateChanged(user => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        console.log("Firebase initialized and user authenticated:", userId);
                        // Start listening for fuel logs once authenticated
                        listenForFuelLogs();
                    } else {
                        userIdDisplay.textContent = '–ù–µ–º–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞';
                        console.log("No user authenticated.");
                    }
                });

            } catch (error) {
                console.error("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó Firebase –∞–±–æ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó:", error);
                addLogMessage.textContent = `–ü–æ–º–∏–ª–∫–∞: ${error.message}`;
                addLogMessage.classList.add('text-red-500');
            }
        }

        // Function to add a new fuel log
        async function addFuelLog() {
            const odometer = parseFloat(odometerRefuelInput.value);
            const fuelAdded = parseFloat(fuelAddedInput.value);

            if (isNaN(odometer) || isNaN(fuelAdded) || odometer <= 0 || fuelAdded <= 0) {
                addLogMessage.textContent = '–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –¥—ñ–π—Å–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è –æ–¥–æ–º–µ—Ç—Ä–∞ —Ç–∞ –ø–∞–ª–∏–≤–∞.';
                addLogMessage.classList.remove('text-green-500');
                addLogMessage.classList.add('text-red-500');
                return;
            }

            addFuelLogBtnText.classList.add('hidden');
            addFuelLogSpinner.classList.remove('hidden');
            addFuelLogBtn.disabled = true;
            addLogMessage.textContent = ''; // Clear previous messages

            try {
                const fuelLogsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/fuel_logs`);
                await addDoc(fuelLogsCollectionRef, {
                    odometer: odometer,
                    fuelAdded: fuelAdded,
                    timestamp: Date.now() // Store timestamp for sorting
                });

                addLogMessage.textContent = '–ó–∞–ø–∏—Å —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!';
                addLogMessage.classList.remove('text-red-500');
                addLogMessage.classList.add('text-green-500');
                odometerRefuelInput.value = '';
                fuelAddedInput.value = '';
            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –¥–æ–∫—É–º–µ–Ω—Ç–∞: ", e);
                addLogMessage.textContent = `–ü–æ–º–∏–ª–∫–∞: ${e.message}`;
                addLogMessage.classList.remove('text-green-500');
                addLogMessage.classList.add('text-red-500');
            } finally {
                addFuelLogBtnText.classList.remove('hidden');
                addFuelLogSpinner.classList.add('hidden');
                addFuelLogBtn.disabled = false;
            }
        }

        // Function to estimate current fuel
        async function estimateCurrentFuel() {
            const currentOdometer = parseFloat(currentOdometerEstimateInput.value);

            if (isNaN(currentOdometer) || currentOdometer <= 0) {
                estimateMessage.textContent = '–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –¥—ñ–π—Å–Ω–∏–π –ø–æ—Ç–æ—á–Ω–∏–π –ø–æ–∫–∞–∑–Ω–∏–∫ –æ–¥–æ–º–µ—Ç—Ä–∞.';
                estimateMessage.classList.remove('text-green-500');
                estimateMessage.classList.add('text-red-500');
                return;
            }

            if (!lastFuelLog) {
                estimateMessage.textContent = '–ë—É–¥—å –ª–∞—Å–∫–∞, –¥–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–∏–Ω –∑–∞–ø–∏—Å –ø—Ä–æ –∑–∞–ø—Ä–∞–≤–∫—É, —â–æ–± –∑—Ä–æ–±–∏—Ç–∏ –æ—Ü—ñ–Ω–∫—É.';
                estimateMessage.classList.remove('text-green-500');
                estimateMessage.classList.add('text-red-500');
                estimateResultsDiv.classList.add('hidden');
                return;
            }

            estimateFuelBtnText.classList.add('hidden');
            estimateFuelSpinner.classList.remove('hidden');
            estimateFuelBtn.disabled = true;
            estimateMessage.textContent = ''; // Clear previous messages
            estimateResultsDiv.classList.add('hidden');

            try {
                const lastRefuelOdometer = lastFuelLog.odometer;
                const lastFuelAdded = lastFuelLog.fuelAdded;

                if (currentOdometer < lastRefuelOdometer) {
                    estimateMessage.textContent = '–ü–æ—Ç–æ—á–Ω–∏–π –æ–¥–æ–º–µ—Ç—Ä –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –º–µ–Ω—à–∏–º –∑–∞ –æ–¥–æ–º–µ—Ç—Ä –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –∑–∞–ø—Ä–∞–≤–∫–∏.';
                    estimateMessage.classList.remove('text-green-500');
                    estimateMessage.classList.add('text-red-500');
                    return;
                }

                const distanceDrivenSinceLastRefuel = currentOdometer - lastRefuelOdometer;
                const fuelConsumedSinceLastRefuel = (distanceDrivenSinceLastRefuel / 100) * FUEL_CONSUMPTION_RATE_L_PER_100KM;

                let estimatedFuelRemaining = lastFuelAdded - fuelConsumedSinceLastRefuel;
                if (estimatedFuelRemaining < 0) {
                    estimatedFuelRemaining = 0; // Cannot have negative fuel
                }

                const estimatedDistanceRemaining = (estimatedFuelRemaining / FUEL_CONSUMPTION_RATE_L_PER_100KM) * 100;

                fuelRemainingSpan.textContent = estimatedFuelRemaining.toFixed(2);
                distanceRemainingSpan.textContent = Math.round(estimatedDistanceRemaining);
                estimateResultsDiv.classList.remove('hidden');
                estimateMessage.textContent = '–û—Ü—ñ–Ω–∫–∞ –≥–æ—Ç–æ–≤–∞!';
                estimateMessage.classList.remove('text-red-500');
                estimateMessage.classList.add('text-green-500');

            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –æ—Ü—ñ–Ω–∫–∏ –ø–∞–ª–∏–≤–∞: ", e);
                estimateMessage.textContent = `–ü–æ–º–∏–ª–∫–∞: ${e.message}`;
                estimateMessage.classList.remove('text-green-500');
                estimateMessage.classList.add('text-red-500');
            } finally {
                estimateFuelBtnText.classList.remove('hidden');
                estimateFuelSpinner.classList.add('hidden');
                estimateFuelBtn.disabled = false;
            }
        }

        // Function to display fuel logs
        function displayFuelLogs(logs) {
            fuelLogsList.innerHTML = ''; // Clear existing list
            if (logs.length === 0) {
                noLogsMessage.classList.remove('hidden');
            } else {
                noLogsMessage.classList.add('hidden');
                // Sort logs by timestamp in descending order (newest first)
                logs.sort((a, b) => b.timestamp - a.timestamp);

                // Set the lastFuelLog for estimation
                lastFuelLog = logs[0];

                logs.forEach(log => {
                    const logItem = document.createElement('div');
                    logItem.className = 'bg-emerald-50 p-4 rounded-lg border border-emerald-100';
                    const date = new Date(log.timestamp).toLocaleString('uk-UA', {
                        year: 'numeric', month: 'numeric', day: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });
                    logItem.innerHTML = `
                        <p class="text-gray-800 font-semibold">–î–∞—Ç–∞: ${date}</p>
                        <p class="text-gray-700">–û–¥–æ–º–µ—Ç—Ä: <span class="font-medium">${log.odometer} –∫–º</span></p>
                        <p class="text-gray-700">–î–æ–¥–∞–Ω–æ –ø–∞–ª–∏–≤–∞: <span class="font-medium">${log.fuelAdded} –ª</span></p>
                    `;
                    fuelLogsList.appendChild(logItem);
                });
            }
        }

        // Listen for real-time updates to fuel logs
        function listenForFuelLogs() {
            logsLoadingSpinner.classList.remove('hidden');
            const fuelLogsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/fuel_logs`);
            onSnapshot(fuelLogsCollectionRef, (snapshot) => {
                const logs = [];
                snapshot.forEach(doc => {
                    logs.push(doc.data());
                });
                displayFuelLogs(logs);
                logsLoadingSpinner.classList.add('hidden');
            }, (error) => {
                console.error("–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∑–∞–ø–∏—Å—ñ–≤ –ø–∞–ª–∏–≤–∞: ", error);
                fuelLogsList.innerHTML = `<p class="text-red-500 text-center">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–ø–∏—Å—ñ–≤: ${error.message}</p>`;
                logsLoadingSpinner.classList.add('hidden');
            });
        }

        // Event Listeners
        addFuelLogBtn.addEventListener('click', addFuelLog);
        estimateFuelBtn.addEventListener('click', estimateCurrentFuel);

        // Handle welcome screen and app initialization
        continueBtn.addEventListener('click', () => {
            welcomeScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            initializeFirebase(); // Initialize Firebase only after clicking continue
        });

        // Initially hide the main app content and show the welcome screen
        document.addEventListener('DOMContentLoaded', () => {
            mainApp.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
        });
    </script>
</body>
</html>
